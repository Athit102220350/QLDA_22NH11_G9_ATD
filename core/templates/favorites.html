{% extends 'base.html' %}

{% block title %}My Favorite Words - English Learning Website{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
{% load static %}
<link rel="stylesheet" href="{% static 'css/components/favorites.css' %}">
<style>
    .pronunciation {
        font-family: Arial, sans-serif;
        color: #6610f2;
        margin-bottom: 10px;
    }
    
    .audio-player {
        margin: 10px 0;
    }
    
    /* Level badges */
    .level-A1 { background-color: #d4edda; color: #155724; }
    .level-A2 { background-color: #d1ecf1; color: #0c5460; }
    .level-B1 { background-color: #fff3cd; color: #856404; }
    .level-B2 { background-color: #f8d7da; color: #721c24; }
    .level-C1 { background-color: #cce5ff; color: #004085; }
    .level-C2 { background-color: #e2e3e5; color: #383d41; }
    
    /* Word details section */
    .word-details {
        position: relative;
    }
    
    .badge-container {
        margin-bottom: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
    }
    
    .collapse-toggle {
        color: #6c757d;
        cursor: pointer;
        display: block;
        text-align: center;
        padding: 5px;
        margin: 10px 0;
        background-color: #f8f9fa;
        border-radius: 4px;
    }
    
    .collapse-toggle:hover {
        background-color: #e9ecef;
    }
    
    .word-card {
        transition: all 0.3s ease;
    }
    
    .word-card:hover {
        box-shadow: 0 .5rem 1rem rgba(0,0,0,.15)!important;
    }
    
    /* Custom card header */
    .card-header-custom {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1.25rem;
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    /* Topic tag styling */
    .topic-tag {
        background-color: #e9ecef;
        color: #495057;
        border-radius: 20px;
        padding: 3px 10px;
        font-size: 0.8rem;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container py-4">
  <div class="row">
    <div class="col-md-3">
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Navigation</h4>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-speedometer2 me-2"></i>Dashboard
                </a>
                <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-person me-2"></i>Profile
                </a>
                <a href="{% url 'favorites' %}" class="list-group-item list-group-item-action active">
                    <i class="bi bi-bookmark-heart-fill me-2"></i>My Vocabulary
                </a>
                <a href="{% url 'progress' %}" class="list-group-item list-group-item-action">
                    <i class="bi bi-graph-up me-2"></i>Learning Progress
                </a>
            </div>
        </div>
        
        <div class="card mb-4 shadow-sm">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0">Filter Words</h4>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="search" class="form-label">
                        <i class="bi bi-search me-1"></i>Search:
                    </label>
                    <input type="text" id="search" class="form-control" placeholder="Type to search...">
                </div>
                
                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-filter me-1"></i>Status:
                    </label>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status-filter" id="filter-all" value="all" checked>
                        <label class="form-check-label" for="filter-all">
                            All Words
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status-filter" id="filter-mastered" value="mastered">
                        <label class="form-check-label" for="filter-mastered">
                            Mastered Only
                        </label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="status-filter" id="filter-learning" value="learning">
                        <label class="form-check-label" for="filter-learning">
                            Still Learning
                        </label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="topic-filter" class="form-label">
                        <i class="bi bi-tag me-1"></i>Topic:
                    </label>
                    <select id="topic-filter" class="form-select">
                        <option value="all">All Topics</option>
                        {% for topic in topics %}
                            <option value="{{ topic }}">{{ topic|capfirst }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="level-filter" class="form-label">
                        <i class="bi bi-bar-chart me-1"></i>Difficulty Level:
                    </label>
                    <select id="level-filter" class="form-select">
                        <option value="all">All Levels</option>
                        {% for level in difficulty_levels %}
                            <option value="{{ level.code }}">{{ level.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3">
                    <label for="sort" class="form-label">
                        <i class="bi bi-sort-alpha-down me-1"></i>Sort By:
                    </label>
                    <select id="sort" class="form-select">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="alphabetical">Alphabetical</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0">My Vocabulary List</h3>
                <span class="badge bg-white text-primary">{{ total_count }} words</span>
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
                
                {% if favorites %}
                    <div id="vocabulary-list">
                        <div class="row">
                            {% for word in favorites %}
                                <div class="col-md-6 mb-3 word-item" 
                                     data-word="{{ word.word }}" 
                                     data-mastered="{{ word.mastered|lower }}"
                                     data-date="{{ word.date_added|date:'U' }}"
                                     data-topic="{{ word.topic|default:'' }}"
                                     data-level="{{ word.level|default:'' }}">
                                    <div class="card h-100 word-card {% if word.mastered %}border-success{% endif %}">
                                        <div class="card-header-custom">
                                            <div>
                                                <h5 class="mb-0">{{ word.word }}</h5>
                                                <div class="small">
                                                    {% if word.part_of_speech %}
                                                        <span class="badge bg-secondary me-1">{{ word.part_of_speech }}</span>
                                                    {% endif %}
                                                    
                                                    {% if word.level %}
                                                        <span class="badge level-{{ word.level }}">{{ word.level }}</span>
                                                    {% endif %}
                                                    
                                                    {% if word.mastered %}
                                                        <span class="badge bg-success">Mastered</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline-danger delete-word" data-id="{{ word.id }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="card-body">
                                            <div class="word-details">
                                                <!-- Topic tag if available -->
                                                {% if word.topic %}
                                                    <div class="mb-2">
                                                        <span class="topic-tag">
                                                            <i class="bi bi-tag-fill me-1"></i>{{ word.topic|capfirst }}
                                                        </span>
                                                    </div>
                                                {% endif %}
                                                
                                                <!-- Pronunciation if available -->
                                                {% if word.pronunciation %}
                                                    <div class="pronunciation">{{ word.pronunciation }}</div>
                                                {% endif %}
                                                
                                                <!-- Audio player if available -->
                                                {% if word.audio %}
                                                    <div class="audio-player">
                                                        <audio controls src="{{ word.audio }}" class="w-100" style="height: 40px;">
                                                            Your browser does not support the audio element.
                                                        </audio>
                                                    </div>
                                                {% endif %}
                                                
                                                <p><strong>Definition:</strong> {{ word.definition }}</p>
                                                
                                                {% if word.example %}
                                                    <p><strong>Example:</strong> <em>{{ word.example }}</em></p>
                                                {% endif %}
                                                
                                                {% if word.synonyms %}
                                                    <p><strong>Synonyms:</strong> {{ word.synonyms }}</p>
                                                {% endif %}
                                                
                                                <p class="text-muted mt-2"><small>Added on {{ word.date_added|date:"F j, Y" }}</small></p>
                                            </div>
                                        </div>
                                        
                                        <div class="card-footer bg-transparent">
                                            <button class="btn btn-sm btn-outline-primary toggle-mastered" data-id="{{ word.id }}">
                                                {% if word.mastered %}
                                                    <i class="bi bi-x-circle"></i> Mark as Not Mastered
                                                {% else %}
                                                    <i class="bi bi-check-circle"></i> Mark as Mastered
                                                {% endif %}
                                            </button>
                                            
                                            <!-- Practice button -->
                                            <a href="#" class="btn btn-sm btn-outline-success float-end practice-word" 
                                               data-word="{{ word.word }}" 
                                               data-bs-toggle="modal" 
                                               data-bs-target="#practiceModal">
                                                <i class="bi bi-journal-text"></i> Practice
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-info">
                        <p>You haven't saved any vocabulary words yet. To add words to your list:</p>
                        <ol>
                            <li>Use the Chatbot to lookup vocabulary words</li>
                            <li>Visit the Vocabulary page to explore words</li>
                            <li>Click "Save" when you find words you want to learn</li>
                        </ol>
                        <div class="text-center mt-3">
                            <a href="{% url 'vocabulary_list' %}" class="btn btn-primary">
                                <i class="bi bi-journal-text"></i> Go to Vocabulary Page
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
  </div>
</div>

<!-- Practice Word Modal -->
<div class="modal fade" id="practiceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Practice Word</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="practice-container text-center">
                    <h2 id="practice-word" class="display-4 mb-4"></h2>
                    
                    <div id="practice-pronunciation" class="pronunciation mb-3"></div>
                    
                    <div id="practice-audio-container" class="mb-4"></div>
                    
                    <div class="card mb-4">
                        <div class="card-body">
                            <p class="lead">Try to recall the definition of this word:</p>
                            <button class="btn btn-primary" id="show-definition-btn">Show Definition</button>
                            
                            <div id="definition-content" style="display: none;" class="mt-3">
                                <hr>
                                <div id="practice-definition" class="mb-3"></div>
                                <div id="practice-example" class="fst-italic mb-3"></div>
                                <div id="practice-synonyms" class="small text-muted"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success" id="mark-mastered-btn">
                            <i class="bi bi-check-circle"></i> Mark as Mastered
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search');
        const statusFilters = document.querySelectorAll('input[name="status-filter"]');
        const topicFilter = document.getElementById('topic-filter');
        const levelFilter = document.getElementById('level-filter');
        const sortSelect = document.getElementById('sort');
        const wordItems = document.querySelectorAll('.word-item');
        
        // Filter and sort function
        function filterAndSortWords() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusFilter = document.querySelector('input[name="status-filter"]:checked').value;
            const topicValue = topicFilter.value;
            const levelValue = levelFilter.value;
            const sortBy = sortSelect.value;
            
            // Create an array from the word items for sorting
            const wordItemsArray = Array.from(wordItems);
            
            // Sort the array
            if (sortBy === 'newest') {
                wordItemsArray.sort((a, b) => {
                    return parseInt(b.dataset.date) - parseInt(a.dataset.date);
                });
            } else if (sortBy === 'oldest') {
                wordItemsArray.sort((a, b) => {
                    return parseInt(a.dataset.date) - parseInt(b.dataset.date);
                });
            } else if (sortBy === 'alphabetical') {
                wordItemsArray.sort((a, b) => {
                    return a.dataset.word.localeCompare(b.dataset.word);
                });
            }
            
            // Process each word item
            wordItemsArray.forEach(item => {
                const word = item.dataset.word.toLowerCase();
                const isMastered = item.dataset.mastered === 'true';
                const topic = item.dataset.topic.toLowerCase();
                const level = item.dataset.level;
                
                // Check if it matches the search
                const matchesSearch = word.includes(searchTerm);
                
                // Check if it matches the status filter
                let matchesStatus = true;
                if (statusFilter === 'mastered') {
                    matchesStatus = isMastered;
                } else if (statusFilter === 'learning') {
                    matchesStatus = !isMastered;
                }
                
                // Check if it matches the topic filter
                const matchesTopic = topicValue === 'all' || topic === topicValue.toLowerCase();
                
                // Check if it matches the level filter
                const matchesLevel = levelValue === 'all' || level === levelValue;
                
                // Show/hide based on filters
                if (matchesSearch && matchesStatus && matchesTopic && matchesLevel) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Re-append in sorted order
            const container = document.querySelector('#vocabulary-list .row');
            wordItemsArray.forEach(item => {
                container.appendChild(item);
            });
        }
        
        // Add event listeners
        searchInput.addEventListener('input', filterAndSortWords);
        statusFilters.forEach(filter => {
            filter.addEventListener('change', filterAndSortWords);
        });
        topicFilter.addEventListener('change', filterAndSortWords);
        levelFilter.addEventListener('change', filterAndSortWords);
        sortSelect.addEventListener('change', filterAndSortWords);
        
        // Toggle word mastered status
        const toggleButtons = document.querySelectorAll('.toggle-mastered');
        toggleButtons.forEach(button => {
            button.addEventListener('click', function() {
                const wordId = this.dataset.id;
                
                fetch('{% url "mark_word_mastered" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify({ word_id: wordId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Reload the page to show updated status
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        });
        
        // Delete word
        const deleteButtons = document.querySelectorAll('.delete-word');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (confirm('Are you sure you want to remove this word from your vocabulary list?')) {
                    const wordId = this.dataset.id;
                    
                    fetch('{% url "delete_saved_word" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                        },
                        body: JSON.stringify({ word_id: wordId })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Remove the word card from the DOM
                            this.closest('.word-item').remove();
                            alert(data.message);
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred. Please try again.');
                    });
                }
            });
        });
        
        // Practice modal functionality
        const practiceButtons = document.querySelectorAll('.practice-word');
        const practiceModal = document.getElementById('practiceModal');
        const showDefinitionBtn = document.getElementById('show-definition-btn');
        const definitionContent = document.getElementById('definition-content');
        
        practiceButtons.forEach(button => {
            button.addEventListener('click', function() {
                const wordCard = this.closest('.word-card');
                const word = this.dataset.word;
                
                // Reset modal state
                definitionContent.style.display = 'none';
                showDefinitionBtn.style.display = 'inline-block';
                
                // Set word in modal
                document.getElementById('practice-word').textContent = word;
                
                // Find data from the card
                const pronunciation = wordCard.querySelector('.pronunciation')?.textContent || '';
                const definition = wordCard.querySelector('p:nth-of-type(1)')?.textContent.replace('Definition:', '') || '';
                const example = wordCard.querySelector('p:nth-of-type(2)')?.textContent.replace('Example:', '') || '';
                const synonyms = wordCard.querySelector('p:nth-of-type(3)')?.textContent.replace('Synonyms:', '') || '';
                const audio = wordCard.querySelector('audio')?.src || '';
                
                // Set data in modal
                document.getElementById('practice-pronunciation').textContent = pronunciation;
                document.getElementById('practice-definition').innerHTML = `<strong>Definition:</strong> ${definition}`;
                
                if (example) {
                    document.getElementById('practice-example').innerHTML = `<strong>Example:</strong> ${example}`;
                } else {
                    document.getElementById('practice-example').innerHTML = '';
                }
                
                if (synonyms) {
                    document.getElementById('practice-synonyms').innerHTML = `<strong>Synonyms:</strong> ${synonyms}`;
                } else {
                    document.getElementById('practice-synonyms').innerHTML = '';
                }
                
                // Add audio if available
                const audioContainer = document.getElementById('practice-audio-container');
                if (audio) {
                    audioContainer.innerHTML = `
                        <audio controls src="${audio}" class="w-100" style="height: 40px;">
                            Your browser does not support the audio element.
                        </audio>
                    `;
                } else {
                    audioContainer.innerHTML = '';
                }
                
                // Set up Mark as Mastered button
                const isMastered = wordCard.classList.contains('border-success');
                const markMasteredBtn = document.getElementById('mark-mastered-btn');
                
                if (isMastered) {
                    markMasteredBtn.innerHTML = '<i class="bi bi-x-circle"></i> Mark as Not Mastered';
                    markMasteredBtn.classList.add('btn-outline-warning');
                    markMasteredBtn.classList.remove('btn-success');
                } else {
                    markMasteredBtn.innerHTML = '<i class="bi bi-check-circle"></i> Mark as Mastered';
                    markMasteredBtn.classList.add('btn-success');
                    markMasteredBtn.classList.remove('btn-outline-warning');
                }
                
                // Set up Mark as Mastered button action
                markMasteredBtn.onclick = function() {
                    const toggleBtn = wordCard.querySelector('.toggle-mastered');
                    toggleBtn.click();
                };
            });
        });
        
        // Show definition button
        showDefinitionBtn.addEventListener('click', function() {
            definitionContent.style.display = 'block';
            this.style.display = 'none';
        });
        
        // Reset practice modal when closed
        practiceModal.addEventListener('hidden.bs.modal', function() {
            definitionContent.style.display = 'none';
            showDefinitionBtn.style.display = 'inline-block';
        });
    });
</script>
{% endblock %}