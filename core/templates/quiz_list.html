{% extends 'base.html' %}

{% block title %}Quizzes - English Learning Website{% endblock %}

{% block extra_css %}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="{% static 'css/components/quiz.css' %}">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Navigation</h4>
            </div>
            <div class="list-group list-group-flush">
                <a href="{% url 'dashboard' %}" class="list-group-item list-group-item-action">Dashboard</a>
                <a href="{% url 'profile' %}" class="list-group-item list-group-item-action">Profile</a>
                <a href="{% url 'favorites' %}" class="list-group-item list-group-item-action">My Vocabulary</a>
                <a href="{% url 'progress' %}" class="list-group-item list-group-item-action">Learning Progress</a>
                <a href="{% url 'quiz_list' %}" class="list-group-item list-group-item-action active">Quizzes</a>
            </div>
        </div>
        
        <!-- Quiz Filters -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h4>Filters</h4>
            </div>
            <div class="card-body">
                <h5>Categories</h5>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action active filter-btn" data-filter="all">All Categories</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter="grammar">Grammar</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter="vocabulary">Vocabulary</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter="reading">Reading</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter="listening">Listening</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter="general">General English</button>
                </div>
                
                <h5>Difficulty</h5>
                <div class="list-group mb-3">
                    <button class="list-group-item list-group-item-action active filter-btn" data-filter-difficulty="all">All Levels</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter-difficulty="beginner">Beginner</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter-difficulty="intermediate">Intermediate</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter-difficulty="advanced">Advanced</button>
                </div>
                
                <h5>Status</h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action active filter-btn" data-filter-status="all">All Quizzes</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter-status="completed">Completed</button>
                    <button class="list-group-item list-group-item-action filter-btn" data-filter-status="incomplete">Not Completed</button>
                </div>
            </div>
        </div>
    </div>
      <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Available Quizzes</h2>
            <div class="d-flex gap-2">
                <a href="{% url 'quiz_leaderboard' %}" class="btn btn-success">
                    <i class="bi bi-trophy"></i> Leaderboard
                </a>
                <div class="input-group" style="max-width: 300px;">
                    <input type="text" id="search-quiz" class="form-control" placeholder="Search quizzes...">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
            </div>
        </div>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
        
        <div class="row" id="quiz-container">
            {% for quiz in quizzes %}
                <div class="col-md-6 col-lg-4 mb-4 quiz-item" 
                     data-category="{{ quiz.category }}" 
                     data-difficulty="{{ quiz.difficulty }}"
                     data-status="{% if quiz.id in attempts_dict and attempts_dict.quiz.id.completed %}completed{% else %}incomplete{% endif %}">
                    <div class="card quiz-card h-100">
                        <div class="card-header {% if quiz.difficulty == 'beginner' %}bg-success{% elif quiz.difficulty == 'intermediate' %}bg-warning{% else %}bg-danger{% endif %} text-white">
                            <h5 class="mb-0">{{ quiz.title }}</h5>
                            <span class="badge bg-light text-dark difficulty-badge">{{ quiz.difficulty|title }}</span>
                        </div>
                        <div class="card-body">
                            <p>{{ quiz.description|truncatechars:120 }}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-info text-white">{{ quiz.category|title }}</span>
                                <small class="text-muted">{{ quiz.get_question_count }} questions</small>
                            </div>
                            
                            {% if quiz.id in attempts_dict %}
                                <div class="mt-3">
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar {% if attempts_dict.quiz.id.score >= 80 %}bg-success{% elif attempts_dict.quiz.id.score >= 60 %}bg-info{% elif attempts_dict.quiz.id.score >= 40 %}bg-warning{% else %}bg-danger{% endif %}" 
                                             role="progressbar" 
                                             style="width: '{{ attempts_dict.quiz.id.score }}'" 
                                             aria-valuenow="{{ attempts_dict.quiz.id.score }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                        </div>
                                    </div>
                                    <small class="text-muted">Your score: {{ attempts_dict.quiz.id.score }}%</small>
                                </div>
                            {% endif %}
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'take_quiz' quiz.id %}" class="btn btn-primary w-100">
                                {% if quiz.id in attempts_dict and attempts_dict.quiz.id.completed %}
                                    <i class="bi bi-arrow-repeat"></i> Retry Quiz
                                {% else %}
                                    <i class="bi bi-play-fill"></i> Start Quiz
                                {% endif %}
                            </a>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-12">
                    <div class="alert alert-info">
                        No quizzes available at this time. Please check back later.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Filter variables
        let activeCategory = 'all';
        let activeDifficulty = 'all';
        let activeStatus = 'all';
        let searchTerm = '';
        
        // Get all quiz items
        const quizItems = document.querySelectorAll('.quiz-item');
        const categoryButtons = document.querySelectorAll('[data-filter]');
        const difficultyButtons = document.querySelectorAll('[data-filter-difficulty]');
        const statusButtons = document.querySelectorAll('[data-filter-status]');
        const searchInput = document.getElementById('search-quiz');
        const clearSearchBtn = document.getElementById('clear-search');
        
        // Filter function
        function filterQuizzes() {
            quizItems.forEach(item => {
                const category = item.dataset.category;
                const difficulty = item.dataset.difficulty;
                const status = item.dataset.status;
                const title = item.querySelector('.card-header h5').textContent.toLowerCase();
                const description = item.querySelector('.card-body p').textContent.toLowerCase();
                
                const matchesCategory = activeCategory === 'all' || category === activeCategory;
                const matchesDifficulty = activeDifficulty === 'all' || difficulty === activeDifficulty;
                const matchesStatus = activeStatus === 'all' || status === activeStatus;
                const matchesSearch = searchTerm === '' || 
                                     title.includes(searchTerm) || 
                                     description.includes(searchTerm);
                
                if (matchesCategory && matchesDifficulty && matchesStatus && matchesSearch) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Check if any quizzes are visible
            const visibleQuizzes = document.querySelectorAll('.quiz-item[style="display: ;"]');
            const quizContainer = document.getElementById('quiz-container');
            
            if (visibleQuizzes.length === 0) {
                // If no quizzes match filters, show message
                if (!document.getElementById('no-quizzes-message')) {
                    const messageDiv = document.createElement('div');
                    messageDiv.id = 'no-quizzes-message';
                    messageDiv.className = 'col-12';
                    messageDiv.innerHTML = `
                        <div class="alert alert-info">
                            No quizzes match your current filters. Try changing your filter criteria.
                        </div>
                    `;
                    quizContainer.appendChild(messageDiv);
                }
            } else {
                // Remove message if it exists
                const messageDiv = document.getElementById('no-quizzes-message');
                if (messageDiv) {
                    messageDiv.remove();
                }
            }
        }
        
        // Category filter event listeners
        categoryButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class
                categoryButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Set active filter
                activeCategory = this.dataset.filter;
                
                // Apply filters
                filterQuizzes();
            });
        });
        
        // Difficulty filter event listeners
        difficultyButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class
                difficultyButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Set active filter
                activeDifficulty = this.dataset.filterDifficulty;
                
                // Apply filters
                filterQuizzes();
            });
        });
        
        // Status filter event listeners
        statusButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class
                statusButtons.forEach(btn => btn.classList.remove('active'));
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Set active filter
                activeStatus = this.dataset.filterStatus;
                
                // Apply filters
                filterQuizzes();
            });
        });
        
        // Search functionality
        searchInput.addEventListener('input', function() {
            searchTerm = this.value.toLowerCase();
            filterQuizzes();
        });
        
        // Clear search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchTerm = '';
            filterQuizzes();
        });
    });
</script>
{% endblock %}
